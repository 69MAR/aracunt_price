<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Areca Nut Price Predictor & Forecast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center min-h-screen p-4">
    
    <div class="w-full max-w-md md:max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8 mb-6">
        
        <div class="text-center mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">Areca Nut Price Predictor</h1>
            <p id="currentDate" class="text-gray-500 mt-2 text-lg"></p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 mb-8">
            <div id="predictionResult" class="flex flex-col items-center justify-center bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[150px]">
                <p class="text-center text-gray-500">Click a button below to get started.</p>
            </div>

            <div class="flex flex-col space-y-4">
                <p class="text-xl font-semibold text-gray-700">1. Single-Day Prediction</p>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="predictPrice('adike')" id="predictAdikeButton" class="flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-500/50">
                        Predict Adike Price
                    </button>
                    <button onclick="predictPrice('patora')" id="predictPatoraButton" class="flex-1 bg-teal-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 hover:bg-teal-700 focus:outline-none focus:ring-4 focus:ring-teal-500/50">
                        Predict Patora Price
                    </button>
                </div>
                
                <p class="text-xl font-semibold text-gray-700 pt-4 border-t mt-4">2. Price Forecast (7 Days)</p>
                <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <button onclick="generateForecast('adike')" id="forecastAdikeButton" class="flex-1 bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500/50">
                        Graph Adike Forecast
                    </button>
                    <button onclick="generateForecast('patora')" id="forecastPatoraButton" class="flex-1 bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 hover:bg-purple-700 focus:outline-none focus:ring-4 focus:ring-purple-500/50">
                        Graph Patora Forecast
                    </button>
                </div>
            </div>
        </div>

        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 id="forecastTitle" class="text-2xl font-bold text-gray-800 mb-4 text-center">7-Day Price Forecast (Historical + Predicted)</h2>
            <div id="chartContainer" class="bg-gray-50 p-4 rounded-lg shadow-inner flex items-center justify-center min-h-[300px]">
                <canvas id="priceChart" class="w-full"></canvas>
                <p id="chartMessage" class="text-gray-500">Select a type and click a "Graph Forecast" button to view the price trend.</p>
            </div>
        </div>

    </div>

    <script>
        // *** FIX APPLIED: Corrected to standard local host API URL for Flask backend ***
        // Use the local host IP and the port your Flask API is running on (e.g., 5001)
        // Note: The port 5001 is a common assumption for Flask. Change if your Flask app uses a different port.
        const BASE_API_URL = 'http://127.0.0.1:5001'; 
        
        // DOM Elements
        const resultDiv = document.getElementById('predictionResult');
        const adikeButton = document.getElementById('predictAdikeButton');
        const patoraButton = document.getElementById('predictPatoraButton');
        const forecastAdikeButton = document.getElementById('forecastAdikeButton');
        const forecastPatoraButton = document.getElementById('forecastPatoraButton');
        const chartContainer = document.getElementById('chartContainer');
        const chartMessage = document.getElementById('chartMessage');
        const forecastTitle = document.getElementById('forecastTitle');
        let priceChartInstance = null; // Variable to hold the Chart.js instance

        document.addEventListener('DOMContentLoaded', () => {
            // Display current date on load
            document.getElementById('currentDate').textContent = `Today: ${new Date().toLocaleDateString('en-IN', { dateStyle: 'full' })}`;
            // Initially hide the canvas and show the message
            document.getElementById('priceChart').classList.add('hidden');
        });
        
        // --- 1. Single-Day Prediction Logic ---

        async function predictPrice(type) {
            const button = type === 'adike' ? adikeButton : patoraButton;
            const otherButton = type === 'adike' ? patoraButton : adikeButton;
            const displayType = type.charAt(0).toUpperCase() + type.slice(1);
            
            // Disable buttons and show loading state
            button.disabled = true;
            otherButton.disabled = true;
            button.textContent = `Predicting...`;
            resultDiv.innerHTML = `<div class="text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-700 mx-auto"></div><p class="mt-2 text-indigo-700">Calculating tomorrow's price...</p></div>`;

            try {
                // CORRECTED: Requesting the endpoint /predict on the API base URL
                const response = await fetch(`${BASE_API_URL}/predict`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to parse server response.' }));
                    throw new Error(errorData.error || `Server returned status ${response.status}.`);
                }

                const data = await response.json();
                
                // Calculate price per Kilogram and format to 2 decimal places
                const pricePerKg = (data.predicted_price / 100).toFixed(2);
                const predictedPriceQuintal = data.predicted_price.toLocaleString('en-IN', { minimumFractionDigits: 2 });
                const pricePerKgFormatted = pricePerKg.toLocaleString('en-IN');


                // Display results with improved alignment
                resultDiv.innerHTML = `
                    <div class="text-center bg-white p-4 rounded-lg shadow-lg border-t-4 border-indigo-600">
                        <p class="text-sm text-gray-600 font-medium">Predicted Price for ${displayType} Tomorrow</p>
                        <div class="flex justify-center items-end mt-2">
                            <span class="text-xl font-extrabold text-indigo-700 mr-1">₹</span>
                            <span class="text-5xl font-extrabold text-indigo-700">${predictedPriceQuintal}</span>
                            <span class="text-base text-gray-500 ml-1 pb-1 font-semibold text-end">(Quintal)</span>
                        </div>
                        
                        <div class="text-center mt-4 pt-3 border-t border-gray-200">
                            <span class="text-xl text-gray-800 font-semibold">~ ₹ ${pricePerKgFormatted}</span>
                            <span class="text-base text-gray-500 ml-1 font-semibold text-end">/ kg</span>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Prediction Error:', error);
                // Updated troubleshooting message for local host
                resultDiv.innerHTML = `<p class="text-red-600 font-semibold">Connection Failed.</p><p class="text-xs text-gray-500 mt-1">Error: ${error.message}</p><p class="text-xs text-gray-500 mt-2">**TROUBLESHOOTING:** Ensure your Flask API is running on **http://127.0.0.1:5001**.</p>`;
            } finally {
                // Re-enable both buttons and restore their original text
                adikeButton.disabled = false;
                patoraButton.disabled = false;
                adikeButton.textContent = "Predict Adike Price";
                patoraButton.textContent = "Predict Patora Price";
            }
        }

        // --- 2. 7-Day Forecast Graph Logic ---

        async function generateForecast(type) {
            const button = type === 'adike' ? forecastAdikeButton : forecastPatoraButton;
            const otherButton = type === 'adike' ? forecastPatoraButton : forecastAdikeButton;
            const displayType = type.charAt(0).toUpperCase() + type.slice(1);

            // Disable buttons and show loading state
            button.disabled = true;
            otherButton.disabled = true;
            button.textContent = `Generating Graph...`;
            chartMessage.textContent = `Fetching and calculating 7-day forecast for ${displayType}...`;
            chartMessage.classList.remove('hidden');
            document.getElementById('priceChart').classList.add('hidden');

            try {
                // CORRECTED: Requesting the endpoint /historical_and_forecast_data on the API base URL
                const response = await fetch(`${BASE_API_URL}/historical_and_forecast_data`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to parse server response.' }));
                    throw new Error(errorData.error || `Server returned status ${response.status}.`);
                }

                const data = await response.json();
                
                // Combine labels and data for plotting: Historical (oldest) first, then Forecast (newest)
                const allLabels = data.historical_dates.concat(data.forecast_dates);
                const allData = data.historical_prices.concat(data.forecast_prices);
                
                // Index where the forecast begins (first day of forecast)
                const forecastStartPoint = data.historical_prices.length;

                drawChart(allLabels, allData, displayType, forecastStartPoint);
                forecastTitle.textContent = `${displayType} Price Forecast (Last ${data.historical_dates.length} Days + 7-Day Prediction)`;
                chartMessage.classList.add('hidden');
                document.getElementById('priceChart').classList.remove('hidden');


            } catch (error) {
                console.error('Forecast Error:', error);
                // Updated troubleshooting message for local host
                chartMessage.textContent = `Connection Failed. Error: ${error.message}. TROUBLESHOOTING: Ensure your Flask API is running on http://127.0.0.1:5001.`;
                chartMessage.classList.remove('hidden');
                document.getElementById('priceChart').classList.add('hidden');

            } finally {
                // Re-enable buttons and restore original text
                forecastAdikeButton.disabled = false;
                forecastPatoraButton.disabled = false;
                forecastAdikeButton.textContent = "Graph Adike Forecast";
                forecastPatoraButton.textContent = "Graph Patora Forecast";
            }
        }

        function drawChart(labels, data, title, forecastStart) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart instance if it exists
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }

            // Function to create a custom dashed line for the forecast segment
            const lineSegments = data.map((value, index) => {
                // Apply a dashed line style starting from the forecast point
                return index >= forecastStart ? { borderDash: [5, 5] } : {};
            });
            
            // Create a gradient background for the historical data
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            const primaryColor = title === 'Adike' ? 'rgb(59, 130, 246)' : 'rgb(20, 184, 166)'; // Blue or Teal
            gradient.addColorStop(0, primaryColor.replace('rgb', 'rgba').replace(')', ', 0.4)')); 
            gradient.addColorStop(1, primaryColor.replace('rgb', 'rgba').replace(')', ', 0.0)')); 

            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels, // These are the dates, ordered old to new (Left to Right)
                    datasets: [{
                        label: `${title} Price (Rs./Quintal)`,
                        data: data, // Prices, ordered old to new
                        backgroundColor: gradient,
                        borderColor: primaryColor,
                        borderWidth: 3,
                        tension: 0.2, // Smoother line
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        segment: lineSegments // Apply dashed line only to the forecast
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allows chart to fill container
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price (Rs./Quintal)',
                                font: { size: 14, weight: 'bold' }
                            },
                            ticks: {
                                callback: function(value, index, ticks) {
                                    // Use Indian currency formatting in the Y-axis ticks
                                    return '₹' + value.toLocaleString('en-IN');
                                }
                            }
                        },
                        x: {
                            // This ensures the X-axis treats labels as categories 
                            // and plots them sequentially in the order provided (old to new).
                            type: 'category', 
                            title: {
                                display: true,
                                text: 'Date',
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    const dateLabel = labels[index];
                                    // Explicitly show if the point is Historical or Forecast based on its index
                                    return index < forecastStart ? `Historical: ${dateLabel}` : `Forecast: ${dateLabel}`;
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        // Use Indian currency formatting in the tooltip label
                                        label += '₹' + context.parsed.y.toLocaleString('en-IN');
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            // Setting a fixed height on the container ensures Chart.js renders predictably.
            chartContainer.style.height = '400px'; 
        }

    </script>
</body>
</html>